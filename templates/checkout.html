{% extends "base.html" %}

{% block title %}Checkout - {{ super() }}{% endblock %}

{% block extra_css %}
<style>
.checkout-total-banner {
    background: linear-gradient(135deg, rgba(220, 0, 0, 0.8) 0%, rgba(180, 0, 0, 0.7) 100%);
    padding: 2rem;
    border-radius: 15px;
    text-align: center;
    margin-bottom: 2rem;
    margin-top: 1rem;
    box-shadow: 0 4px 15px rgba(220, 0, 0, 0.3);
}

@media (max-width: 768px) {
    .checkout-total-banner {
        margin-top: 2rem;
    }
}

.checkout-total-banner h3 {
    color: white;
    font-size: 1.8rem;
    font-weight: bold;
    margin: 0;
}

.payment-info-section {
    background: rgba(42, 42, 42, 0.6);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 15px;
    padding: 2rem;
    margin-bottom: 2rem;
}

.payment-info-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem;
    margin-bottom: 0.75rem;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 10px;
    transition: all 0.3s;
}

.payment-info-item:hover {
    background: rgba(255, 255, 255, 0.08);
}

.payment-info-item i {
    font-size: 1.5rem;
    margin-right: 1rem;
    color: var(--primary-color);
}

.payment-info-content {
    display: flex;
    align-items: center;
    flex: 1;
}

.payment-info-text {
    font-size: 1.1rem;
    font-weight: 600;
    color: white;
}

.btn-copy {
    background: rgba(220, 0, 0, 0.2);
    border: 1px solid var(--primary-color);
    color: white;
    padding: 0.4rem 1rem;
    border-radius: 8px;
    font-size: 0.9rem;
    transition: all 0.3s;
}

.btn-copy:hover {
    background: var(--primary-color);
    color: white;
}

.timer-section {
    text-align: center;
    padding: 2rem;
    background: rgba(42, 42, 42, 0.6);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 15px;
    margin-bottom: 2rem;
}

.timer-section h5 {
    color: white;
    font-weight: 600;
    margin-bottom: 1rem;
}

.timer-display {
    font-size: 2.5rem;
    font-weight: bold;
    color: var(--primary-color);
}

.reference-section {
    background: rgba(42, 42, 42, 0.6);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 15px;
    padding: 2rem;
    margin-bottom: 2rem;
}

.reference-input {
    background: rgba(255, 255, 255, 0.05);
    border: 2px solid rgba(255, 255, 255, 0.1);
    color: white;
    font-size: 1.2rem;
    text-align: center;
    letter-spacing: 0.3rem;
    padding: 1rem;
    border-radius: 10px;
    transition: all 0.3s;
}

.reference-input:focus {
    background: rgba(255, 255, 255, 0.08);
    border-color: var(--primary-color);
    color: white;
    box-shadow: 0 0 0 0.2rem rgba(220, 0, 0, 0.25);
}

.reference-indicators {
    display: flex;
    justify-content: center;
    gap: 0.5rem;
    margin-top: 1rem;
}

.reference-dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.2);
    transition: all 0.3s;
}

.reference-dot.filled {
    background: var(--primary-color);
}

.btn-confirm-payment {
    background: var(--primary-color);
    border: none;
    padding: 1rem;
    font-size: 1.2rem;
    font-weight: bold;
    border-radius: 10px;
    transition: all 0.3s;
}

.btn-confirm-payment:hover {
    background: #b30000;
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(220, 0, 0, 0.3);
}

.btn-confirm-payment:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <!-- Banner Total -->
            <div class="checkout-total-banner">
                {% if descuento_porcentaje > 0 %}
                <div class="mb-2">
                    <span class="badge bg-success" style="font-size: 1rem; padding: 0.5rem 1rem;">
                        <i class="bi bi-gift"></i> {{ descuento_porcentaje }}% de descuento aplicado
                    </span>
                </div>
                <p class="mb-2" style="text-decoration: line-through; font-size: 1.2rem; opacity: 0.7;">
                    Precio original: 
                    {% if checkout_data.metodo_pago == 'pagomovil' and config and config.tasa_cambio %}
                        Bs {{ "%.2f"|format(precio_original * config.tasa_cambio) }}
                    {% else %}
                        ${{ "%.2f"|format(precio_original) }} USD
                    {% endif %}
                </p>
                {% endif %}
                <h3>Total a pagar: 
                    {% if checkout_data.metodo_pago == 'pagomovil' and config and config.tasa_cambio %}
                        Bs {{ "%.2f"|format(precio_final * config.tasa_cambio) }}
                    {% else %}
                        ${{ "%.2f"|format(precio_final) }} USD
                    {% endif %}
                </h3>
                {% if afiliado_nombre %}
                <small class="text-white-50">Gracias por usar el código de {{ afiliado_nombre }}</small>
                {% endif %}
            </div>
            <!-- Información de Pago -->
            <div class="payment-info-section">
                <h4 class="text-white fw-bold mb-4 text-center">Información de pago</h4>
                
                {% if checkout_data.metodo_pago == 'pagomovil' %}
                <!-- Pago Móvil -->
                <div class="payment-info-item">
                    <div class="payment-info-content">
                        <i class="bi bi-bank"></i>
                        <span class="payment-info-text">{{ config.pagomovil_banco if config else 'Banco' }}</span>
                    </div>
                    <button type="button" class="btn-copy" onclick="copyToClipboard('{{ config.pagomovil_banco if config else '' }}')">Copiar</button>
                </div>
                
                <div class="payment-info-item">
                    <div class="payment-info-content">
                        <i class="bi bi-person"></i>
                        <span class="payment-info-text">{{ config.pagomovil_titular if config else 'Titular' }}</span>
                    </div>
                    <button type="button" class="btn-copy" onclick="copyToClipboard('{{ config.pagomovil_titular if config else '' }}')">Copiar</button>
                </div>
                
                <div class="payment-info-item">
                    <div class="payment-info-content">
                        <i class="bi bi-phone"></i>
                        <span class="payment-info-text">{{ config.pagomovil_telefono if config else '0424-0000000' }}</span>
                    </div>
                    <button type="button" class="btn-copy" onclick="copyToClipboard('{{ config.pagomovil_telefono if config else '' }}')">Copiar</button>
                </div>
                
                <div class="payment-info-item">
                    <div class="payment-info-content">
                        <i class="bi bi-card-text"></i>
                        <span class="payment-info-text">{{ config.pagomovil_cedula if config else 'V-00000000' }}</span>
                    </div>
                    <button type="button" class="btn-copy" onclick="copyToClipboard('{{ config.pagomovil_cedula if config else '' }}')">Copiar</button>
                </div>
                {% else %}
                <!-- Binance -->
                <div class="payment-info-item">
                    <div class="payment-info-content">
                        <i class="bi bi-envelope"></i>
                        <span class="payment-info-text">{{ config.binance_correo if config else 'ejemplo@correo.com' }}</span>
                    </div>
                    <button type="button" class="btn-copy" onclick="copyToClipboard('{{ config.binance_correo if config else '' }}')">Copiar</button>
                </div>
                
                {% if config and config.binance_pay_id %}
                <div class="payment-info-item">
                    <div class="payment-info-content">
                        <i class="bi bi-credit-card"></i>
                        <span class="payment-info-text">{{ config.binance_pay_id }}</span>
                    </div>
                    <button type="button" class="btn-copy" onclick="copyToClipboard('{{ config.binance_pay_id }}')">Copiar</button>
                </div>
                {% endif %}
                {% endif %}
            </div>

            <!-- Contador de Tiempo -->
            <div class="timer-section">
                <h5>Tiempo restante para completar el pago</h5>
                <div class="timer-display" id="countdown">30:00</div>
            </div>

            <!-- Formulario de Referencia -->
            <form action="{{ url_for('confirmar_orden') }}" method="POST" id="checkoutForm">
                <div class="reference-section">
                    <label class="form-label text-white fw-bold mb-3 text-center d-block">
                        Referencia de pago (6 dígitos)
                    </label>
                    <input type="text" class="form-control reference-input" 
                           name="referencia" id="referenciaInput"
                           placeholder="Ej: 123456"
                           maxlength="6"
                           pattern="[0-9]{6}"
                           required>
                    <div class="reference-indicators" id="referenceIndicators">
                        <div class="reference-dot"></div>
                        <div class="reference-dot"></div>
                        <div class="reference-dot"></div>
                        <div class="reference-dot"></div>
                        <div class="reference-dot"></div>
                        <div class="reference-dot"></div>
                    </div>
                    <small class="form-text text-muted d-block text-center mt-3">
                        Ingresa exactamente los 6 dígitos de tu referencia de pago.
                    </small>
                </div>

                <div class="d-grid gap-2">
                    <button type="submit" class="btn btn-confirm-payment" id="confirmButton" disabled>
                        Confirmar Pago
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Contador de tiempo
let timeLeft = 30 * 60; // 30 minutos en segundos

function updateTimer() {
    const minutes = Math.floor(timeLeft / 60);
    const seconds = timeLeft % 60;
    document.getElementById('countdown').textContent = 
        `${minutes}:${seconds.toString().padStart(2, '0')}`;
    
    if (timeLeft > 0) {
        timeLeft--;
    } else {
        alert('El tiempo ha expirado. Por favor, inicia una nueva orden.');
        window.location.href = '{{ url_for("index") }}';
    }
}

setInterval(updateTimer, 1000);
updateTimer();

// Indicadores de referencia
const referenciaInput = document.getElementById('referenciaInput');
const confirmButton = document.getElementById('confirmButton');
const indicators = document.querySelectorAll('.reference-dot');

referenciaInput.addEventListener('input', function(e) {
    const value = e.target.value;
    
    // Actualizar indicadores
    indicators.forEach((dot, index) => {
        if (index < value.length) {
            dot.classList.add('filled');
        } else {
            dot.classList.remove('filled');
        }
    });
    
    // Habilitar/deshabilitar botón
    confirmButton.disabled = value.length !== 6;
});

// Función para copiar al portapapeles
function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => {
        // Mostrar feedback
        const btn = event.target;
        const originalText = btn.textContent;
        btn.textContent = '✓ Copiado';
        btn.style.background = '#27ae60';
        
        setTimeout(() => {
            btn.textContent = originalText;
            btn.style.background = '';
        }, 2000);
    }).catch(err => {
        alert('Error al copiar: ' + err);
    });
}
</script>
{% endblock %}
